<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <title>ECHO JR ¬∑ UPDATE GOD</title>
  <style>
    :root { --pink1:#ff2e88; --pink2:#ff6b9d; --white:#ffffff; }

    html,body{
      margin:0;height:100%;width:100%;background:transparent;color:var(--pink2);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      display:flex;align-items:center;justify-content:center;text-align:center;overflow:hidden;
    }

    iframe.bg,iframe.front{position:fixed;top:0;left:0;width:100%;height:100%;border:none;background:transparent;pointer-events:none;}
    iframe.bg{z-index:-2;} iframe.front{z-index:0;opacity:.65;}

    .container{position:relative;z-index:2;display:flex;flex-direction:column;align-items:center;}

    footer{font-size:18px;font-weight:900;letter-spacing:2px;text-transform:uppercase;color:var(--pink2);margin-bottom:25px;}

    .jr-btn{
      width:200px;margin:8px;padding:12px 0;border-radius:30px;font-size:18px;font-weight:600;text-align:center;
      background:rgba(255,255,255,0.08);border:2px solid rgba(255,255,255,0.25);color:var(--pink2);cursor:pointer;
      box-shadow:0 4px 20px rgba(255,47,137,0.5);backdrop-filter:blur(12px) saturate(160%);-webkit-backdrop-filter:blur(12px) saturate(160%);
      transition:box-shadow .25s ease,transform .1s ease;
    }
    .jr-btn:hover{box-shadow:0 6px 24px rgba(255,47,137,0.8);transform:scale(1.03);}

    #githubSearch{
      position:fixed;bottom:40px;left:50%;transform:translateX(-50%);width:240px;padding:12px 24px;border-radius:30px;
      font-size:18px;font-weight:600;text-align:center;background:transparent;border:2px solid rgba(255,255,255,0.25);
      color:var(--pink2);box-shadow:0 0 20px rgba(255,47,137,0.4);z-index:200;transition:all .3s ease;
    }
    #githubSearch::placeholder{color:var(--pink2);}
    #githubSearch:focus{outline:none;box-shadow:0 0 26px rgba(255,47,137,0.8);border-color:rgba(255,47,137,0.9);}

    #actionBox{
      position:fixed;top:50%;left:50%;width:360px;height:420px;transform:translate(-50%,-50%) scale(.9);
      background:rgba(255,255,255,0.08);backdrop-filter:blur(12px);border:3px solid var(--pink2);border-radius:20px;color:var(--white);
      display:none;flex-direction:column;z-index:500;box-shadow:0 0 20px rgba(255,47,137,0.4);transition:opacity .3s ease,transform .3s ease;
      opacity:0;overflow:hidden;
    }
    #actionBox.active{display:flex;opacity:1;transform:translate(-50%,-50%) scale(1);}

    #actionHeader{
      padding:12px 16px;border-bottom:2px solid rgba(255,255,255,0.15);display:flex;align-items:center;justify-content:space-between;
    }
    #actionTitle{font-size:18px;color:var(--pink2);margin:0;}
    #closeAction{font-weight:700;color:var(--white);background:var(--pink2);border:none;border-radius:16px;padding:6px 12px;cursor:pointer;}

    #repoList{flex:1;padding:12px 16px;overflow:auto;text-align:left;color:var(--white);}
    .repo{padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.12);}
    .repo a{color:var(--pink2);text-decoration:none;font-weight:700;word-break:break-word;cursor:pointer;}
    .meta{font-size:12px;opacity:.85;margin-top:4px;}

    #chatModal{
      position:fixed;bottom:80px;right:20px;width:320px;height:260px;background:black;border:2px solid #0f0;border-radius:16px;
      box-shadow:0 0 30px #0f0;z-index:600;display:none;flex-direction:column;overflow:hidden;
    }
    #chatModal iframe{width:100%;height:100%;}
    #chatClose{position:absolute;top:6px;right:12px;color:#0f0;font-size:20px;cursor:pointer;z-index:10;}
    #chatBtn{
      margin-top:20px;width:60px;height:60px;border-radius:50%;background:rgba(255,255,255,0.08);border:2px solid rgba(255,255,255,0.25);
      color:var(--pink2);font-size:22px;box-shadow:0 0 20px rgba(255,47,137,0.5);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
      cursor:pointer;transition:transform .2s ease;
    }
    #chatBtn:hover{transform:scale(1.1);}

    /* preview elements inside Remove */
    #previewFrame{width:100%;height:100%;border:none;}
    pre.codePreview{white-space:pre-wrap;word-break:break-word;font-family:monospace;font-size:12px;line-height:1.4;max-height:100%;overflow:auto;margin:0;}
  </style>
</head>
<body>

  <iframe src="luhve.html" class="bg"></iframe>
  <iframe src="luhvefront.html" class="front"></iframe>

  <iframe
    src="spin.html?v=2"
    style="position:absolute;top:calc(50% - 70px);left:50%;transform:translateX(-50%);width:100%;height:60px;border:none;background:transparent;pointer-events:none;z-index:1;">
  </iframe>

  <div class="container">
    <footer>ECHO JR ¬∑ UPDATE GOD</footer>
    <button class="jr-btn" id="addBtn">Add</button>
    <button class="jr-btn" id="removeBtn">Remove</button>
    <button class="jr-btn" id="replaceBtn">Replace</button>
    <button id="chatBtn">help</button>
  </div>

  <input type="text" id="githubSearch" placeholder="GitHub Username" autocomplete="off" />

  <div id="chatModal">
    <div id="chatClose">√ó</div>
    <iframe src="talk2echojr.html" frameborder="0"></iframe>
  </div>

  <div id="actionBox">
    <div id="actionHeader">
      <h2 id="actionTitle">Action Mode</h2>
      <button id="closeAction">Close</button>
    </div>
    <div id="repoList"></div>
  </div>

  <script>
    const input = document.getElementById("githubSearch");
    const actionBox = document.getElementById("actionBox");
    const actionTitle = document.getElementById("actionTitle");
    const repoList = document.getElementById("repoList");
    const closeAction = document.getElementById("closeAction");

    // store last selected file for Remove preview
    let lastSelectedFile = null; // { user, repo, path, downloadUrl, name }

    function openBox(title, content = "") {
      actionTitle.textContent = title;
      if (content) repoList.innerHTML = content;
      actionBox.style.display = "flex";
      requestAnimationFrame(() => actionBox.classList.add("active"));
    }
    function closeBox() {
      actionBox.classList.remove("active");
      setTimeout(() => (actionBox.style.display = "none"), 300);
    }
    if (closeAction) closeAction.addEventListener("click", closeBox);

    // Add / Replace unchanged (textareas). Remove now loads preview of last selected file.
    const addBtn = document.getElementById("addBtn");
    const removeBtn = document.getElementById("removeBtn");
    const replaceBtn = document.getElementById("replaceBtn");

    addBtn.addEventListener("click", () => {
      openBox("Add Mode", '<textarea id="actionInput" style="width:100%;height:80%;background:rgba(0,0,0,0.3);color:var(--pink2);border:none;outline:none;font-family:monospace;font-size:14px;border-radius:10px;padding:10px;resize:none;" placeholder="Type code or text to add..."></textarea>');
    });

    replaceBtn.addEventListener("click", () => {
      openBox("Replace Mode", '<textarea id="actionInput" style="width:100%;height:80%;background:rgba(0,0,0,0.3);color:var(--pink2);border:none;outline:none;font-family:monospace;font-size:14px;border-radius:10px;padding:10px;resize:none;" placeholder="Paste new replacement code..."></textarea>');
    });

    removeBtn.addEventListener("click", async () => {
      openBox("Remove Mode");
      if (!lastSelectedFile) {
        repoList.innerHTML = "<div class='meta'>Select a file first (GitHub search ‚Üí pick a file), then hit Remove.</div>";
        return;
      }
      repoList.innerHTML = `<div class="meta">Loading preview for <strong>${lastSelectedFile.name}</strong>‚Ä¶</div>`;
      try {
        const text = await fetchTextFromLastSelected();
        // If HTML file, render live; else show source in <pre>
        if (/\.(html?|xhtml)$/i.test(lastSelectedFile.name)) {
          repoList.innerHTML = `<iframe id="previewFrame"></iframe>`;
          document.getElementById("previewFrame").srcdoc = text;
        } else {
          repoList.innerHTML = `<pre class="codePreview">${escapeHtml(text)}</pre>`;
        }
      } catch (err) {
        repoList.innerHTML = `<div class="meta">Failed to load preview. ${String(err).slice(0,200)}</div>`;
      }
    });

    async function fetchTextFromLastSelected() {
      // Prefer direct download_url if we have it
      if (lastSelectedFile?.downloadUrl) {
        const r = await fetch(lastSelectedFile.downloadUrl);
        return await r.text();
      }
      // Fallback: query GitHub contents API for this path to get download_url
      const r = await fetch(`https://api.github.com/repos/${encodeURIComponent(lastSelectedFile.user)}/${encodeURIComponent(lastSelectedFile.repo)}/contents/${encodeURIComponent(lastSelectedFile.path)}`);
      const d = await r.json();
      if (d && d.download_url) {
        const r2 = await fetch(d.download_url);
        return await r2.text();
      }
      throw new Error("No download URL available.");
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // GitHub search: Enter ‚Üí list repos (unchanged)
    input.addEventListener("keydown", async (e) => {
      if (e.key !== "Enter") return;
      e.preventDefault();
      const user = input.value.trim();
      if (!user) return;

      actionTitle.textContent = `Repos ¬∑ ${user}`;
      repoList.innerHTML = `<div class="meta">Loading repositories‚Ä¶</div>`;
      openBox(actionTitle.textContent);

      try {
        const res = await fetch(`https://api.github.com/users/${encodeURIComponent(user)}/repos?per_page=100&sort=updated`);
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0) {
          repoList.innerHTML = `<div class="meta">No repositories found for <strong>${user}</strong>.</div>`;
          return;
        }

        repoList.innerHTML = data.map(repo => `
          <div class="repo" data-user="${user}" data-repo="${repo.name}">
            <a href="#" class="repo-link">${repo.name}</a>
            ${repo.description ? `<div class="meta">${repo.description}</div>` : ``}
          </div>
        `).join("");

        document.querySelectorAll(".repo-link").forEach(link => {
          link.addEventListener("click", async (ev) => {
            ev.preventDefault();
            const repoDiv = ev.target.closest(".repo");
            const repoName = repoDiv.getAttribute("data-repo");
            const username = repoDiv.getAttribute("data-user");
            await showFiles(username, repoName);
          });
        });
      } catch (err) {
        repoList.innerHTML = `<div class="meta">Failed to load repos. ${err}</div>`;
      }
    });

    // Files list; selecting a file now stores metadata + closes (unchanged show/close, just stores data)
    async function showFiles(user, repo) {
      actionTitle.textContent = `Files ¬∑ ${repo}`;
      repoList.innerHTML = `<div class="meta">Loading files‚Ä¶</div>`;

      try {
        const res = await fetch(`https://api.github.com/repos/${encodeURIComponent(user)}/${encodeURIComponent(repo)}/contents`);
        const data = await res.json();
        if (!Array.isArray(data)) {
          repoList.innerHTML = `<div class="meta">No files found.</div>`;
          return;
        }

        repoList.innerHTML = data.map(file => {
          const icon = file.type === "dir" ? "üìÅ" : "üìÑ";
          // keep download_url so Remove can preview later
          return `<div class="repo">
            <a href="#" class="file-link"
               data-path="${file.path}"
               data-name="${file.name}"
               data-download="${file.download_url || ''}"
               data-user="${user}"
               data-repo="${repo}">${icon} ${file.name}</a>
          </div>`;
        }).join("");

        document.querySelectorAll(".file-link").forEach(link => {
          link.addEventListener("click", (ev) => {
            ev.preventDefault();
            const el = ev.target.closest(".file-link");
            const path = el.getAttribute("data-path");
            const name = el.getAttribute("data-name");
            const downloadUrl = el.getAttribute("data-download");
            const selUser = el.getAttribute("data-user");
            const selRepo = el.getAttribute("data-repo");

            // store selection for Remove preview
            lastSelectedFile = { user: selUser, repo: selRepo, path, downloadUrl, name };

            // keep current UX: close and fill only filename
            input.value = name;
            closeBox();
            console.log("Selected file cached for Remove:", lastSelectedFile);
          });
        });
      } catch (err) {
        repoList.innerHTML = `<div class="meta">Failed to load files. ${err}</div>`;
      }
    }

    // ESC closes
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && actionBox.classList.contains("active")) closeBox();
    });

    // Chat modal
    const chatBtn = document.getElementById("chatBtn");
    const chatModal = document.getElementById("chatModal");
    const chatClose = document.getElementById("chatClose");
    chatBtn.addEventListener("click", () => { chatModal.style.display = "flex"; });
    chatClose.addEventListener("click", () => { chatModal.style.display = "none"; });
  </script>

</body>
</html>
